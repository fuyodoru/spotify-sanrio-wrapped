const CLIENT_ID = '894e36ebf0a7460f99d52b98b8063ffa';
const REDIRECT_URI = 'https://fuyodoru.github.io/spotify-sanrio-wrapped/'; 
const AUTH_ENDPOINT = 'https://accounts.spotify.com/authorize';
const RESPONSE_TYPE = 'token';
const SCOPES = 'user-top-read';

let accessToken = null; // FIXED: Declare global token

document.addEventListener('DOMContentLoaded', () => {

    // Load saved theme
    const savedTheme = localStorage.getItem('selectedTheme');
    if (savedTheme) {
        document.getElementById("theme").value = savedTheme;
        applyTheme();
    }

    // Login button
    document.getElementById('login-btn').addEventListener('click', () => {
        const authUrl = `${AUTH_ENDPOINT}?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=${RESPONSE_TYPE}&scope=${encodeURIComponent(SCOPES)}`;
        window.location.href = authUrl;
    });

    getAccessToken();

    // Get data button
    document.getElementById('get-data-btn').addEventListener('click', async () => {

        if (!accessToken) {
            alert("Please log in with Spotify first!");
            return;
        }

        const timeRange = document.getElementById('time-range').value;

        try {
            const [tracks, artists] = await Promise.all([
                fetchSpotifyAPI(`https://api.spotify.com/v1/me/top/tracks?limit=10&time_range=${timeRange}`),
                fetchSpotifyAPI(`https://api.spotify.com/v1/me/top/artists?limit=10&time_range=${timeRange}`)
            ]);

            displayTopTracks(tracks.items);
            displayTopArtists(artists.items);
            displayTopGenres(artists.items);

        } catch (error) {
            console.error('Error fetching Spotify data:', error);
        }
    });
});

// Extract token from URL after redirect
function getAccessToken() {
    const hash = window.location.hash;

    if (hash.includes("access_token")) {
        accessToken = new URLSearchParams(hash.substring(1)).get("access_token");

        // Remove hash but keep path (fix for GitHub Pages)
        window.history.replaceState({}, document.title, window.location.pathname);

        document.getElementById('get-data-btn').style.display = 'inline-block';
    }
}

async function fetchSpotifyAPI(url) {
    const response = await fetch(url, {
        headers: { Authorization: `Bearer ${accessToken}` }
    });

    if (!response.ok) {
        throw new Error(`Spotify API error: ${response.status}`);
    }

    return response.json();
}

function displayTopTracks(tracks) {
    const trackList = document.getElementById('top-tracks');
    trackList.innerHTML = '';

    tracks.forEach(track => {
        const item = document.createElement('li');
        item.innerHTML = `
            <div>
                <img src="${track.album.images[0].url}" width="50">
                <span>${track.name} by ${track.artists[0].name}</span>
            </div>
        `;
        trackList.appendChild(item);
    });
}

function displayTopArtists(artists) {
    const artistList = document.getElementById('top-artists');
    artistList.innerHTML = '';

    artists.forEach(artist => {
        const item = document.createElement('li');
        item.innerHTML = `
            <div>
                <img src="${artist.images[0]?.url || ''}" width="50">
                <span>${artist.name}</span>
            </div>
        `;
        artistList.appendChild(item);
    });
}

function displayTopGenres(artists) {
    const genreList = document.getElementById('top-genres');
    genreList.innerHTML = '';

    const genres = artists.flatMap(a => a.genres);
    const unique = [...new Set(genres)];

    unique.forEach(g => {
        const item = document.createElement('li');
        item.textContent = g;
        genreList.appendChild(item);
    });
}

function applyTheme() {
    const theme = document.getElementById("theme").value;
    const container = document.querySelector(".container");

    container.classList.remove("cinnamoroll-theme", "badtz-maru-theme", "hello-kitty-theme", "keroppi-theme");
    container.classList.add(`${theme}-theme`);

    localStorage.setItem('selectedTheme', theme);
}
